<!DOCTYPE html>



  


<html class="theme-next mist use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  
    
      
    

    
  

  

  
    
      
    

    
  

  
    
      
    

    
  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Monda:300,300italic,400,400italic,700,700italic|Roboto Slab:300,300italic,400,400italic,700,700italic|Lobster Two:300,300italic,400,400italic,700,700italic|PT Mono:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.1" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Objective-C,Runtime," />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.png?v=5.1.1" />






<meta name="description" content="写过Objective-C的同学都应该知道，Objective-C里有一个id类型，可以在编写程序时指代任何对象类型，在程序运行起来后再具体确定到底是什么类型。给一个对象发送一个未定义在它的类中的方法在编译期间也不会报错，因为在运行时可以给类再添加方法，也可以改变方法的接收者，甚至是交换两个方法的实现过程。还有一点，我们一直在用，但可能忽略了它也是动态性的一个基础特性，就是可以根据不同的屏幕尺寸加">
<meta property="og:type" content="article">
<meta property="og:title" content="通过Runtime源码看Objective-C的动态性  ">
<meta property="og:url" content="http://shinancao.github.io/2019/06/01/iOS-Runtime-1/index.html">
<meta property="og:site_name" content="意林的小站">
<meta property="og:description" content="写过Objective-C的同学都应该知道，Objective-C里有一个id类型，可以在编写程序时指代任何对象类型，在程序运行起来后再具体确定到底是什么类型。给一个对象发送一个未定义在它的类中的方法在编译期间也不会报错，因为在运行时可以给类再添加方法，也可以改变方法的接收者，甚至是交换两个方法的实现过程。还有一点，我们一直在用，但可能忽略了它也是动态性的一个基础特性，就是可以根据不同的屏幕尺寸加">
<meta property="og:image" content="http://shinancao.github.io/images/class_hierarchy.jpg">
<meta property="og:image" content="http://shinancao.github.io/images/message_invoked.png">
<meta property="og:image" content="http://shinancao.github.io/images/message_forwarding.jpg">
<meta property="og:updated_time" content="2019-09-17T13:58:24.833Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="通过Runtime源码看Objective-C的动态性  ">
<meta name="twitter:description" content="写过Objective-C的同学都应该知道，Objective-C里有一个id类型，可以在编写程序时指代任何对象类型，在程序运行起来后再具体确定到底是什么类型。给一个对象发送一个未定义在它的类中的方法在编译期间也不会报错，因为在运行时可以给类再添加方法，也可以改变方法的接收者，甚至是交换两个方法的实现过程。还有一点，我们一直在用，但可能忽略了它也是动态性的一个基础特性，就是可以根据不同的屏幕尺寸加">
<meta name="twitter:image" content="http://shinancao.github.io/images/class_hierarchy.jpg">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Mist',
    sidebar: {"position":"left","display":"post","offset":12,"offset_float":0,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://shinancao.github.io/2019/06/01/iOS-Runtime-1/"/>





  <title>通过Runtime源码看Objective-C的动态性   | 意林的小站</title>
  














</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">意林的小站</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <h1 class="site-subtitle" itemprop="description">Be a cool girl ~</h1>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://shinancao.github.io/2019/06/01/iOS-Runtime-1/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="意林">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="意林的小站">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">通过Runtime源码看Objective-C的动态性  </h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-06-01T06:40:32+08:00">
                2019-06-01
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/iOS/" itemprop="url" rel="index">
                    <span itemprop="name">iOS</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/iOS/Objective-C/" itemprop="url" rel="index">
                    <span itemprop="name">Objective-C</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>写过Objective-C的同学都应该知道，Objective-C里有一个<code>id</code>类型，可以在编写程序时指代任何对象类型，在程序运行起来后再具体确定到底是什么类型。给一个对象发送一个未定义在它的类中的方法在编译期间也不会报错，因为在运行时可以给类再添加方法，也可以改变方法的接收者，甚至是交换两个方法的实现过程。还有一点，我们一直在用，但可能忽略了它也是动态性的一个基础特性，就是可以根据不同的屏幕尺寸加载不同的启动图片，还可以根据不同屏幕的分辨率加载不同分辨率的资源图片，比如在Retain屏上加载<code>@2x</code>图片，在一些老设备上加载原图，在后来的plus系列设备上加载<code>@3x</code>图片。总结一下，Objective-C动态性体现在3个方面：动态类型、动态绑定、动态加载。下面主要说一下动态类型和动态绑定。</p>
<a id="more"></a>
<h2 id="动态类型"><a href="#动态类型" class="headerlink" title="动态类型"></a>动态类型</h2><h3 id="类和对象的原型"><a href="#类和对象的原型" class="headerlink" title="类和对象的原型"></a>类和对象的原型</h3><p>Objective-C的动态性大多是由<code>Runtime</code>提供的，<code>Runtime</code>是用C/C++和汇编写的，苹果开源了它的代码。源码地址：<a href="https://opensource.apple.com/source/objc4/" target="_blank" rel="external">https://opensource.apple.com/source/objc4/</a>，代码下载地址：<a href="https://opensource.apple.com/tarballs/objc4/" target="_blank" rel="external">https://opensource.apple.com/tarballs/objc4/</a>，其中列出了所有的历史版本。我下面的分析基于<code>objc4-750</code>里的代码。</p>
<p>我们所写的Objective-C代码经过编译器编译会先转换成低级的C/C++代码，通过<code>Runtime</code>的源码，可以看一下对象、类到底是如何定义的，以及类的层次结构是怎样的。</p>
<p>先来看一下对象是如何定义的，下载源码后，可以在<code>Public Header/objc.h</code>中找到对应的定义。</p>
<figure class="highlight smali"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">/// An opaque type that represents an Objective-C class.</span><br><span class="line">typedef struct objc_class *Class;</span><br><span class="line"></span><br><span class="line">/// Represents an<span class="built_in"> instance </span>of a class.</span><br><span class="line">struct objc_object &#123;</span><br><span class="line">    Class _Nonnull isa  OBJC_ISA_AVAI<span class="class">LABILITY;</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">/// A pointer to an<span class="built_in"> instance </span>of a class.</span><br><span class="line">typedef struct objc_object *id;</span><br></pre></td></tr></table></figure>
<p>由此可知，我们写代码时定义的实例对象实际上是一个结构体指针，每一个实例对象都包含了一个<code>isa</code>指针，指向了它所属的类。这也是为什么我们定义实例对象变量时前面都要加上<code>*</code>号。<code>id</code>类型在定义的时候就将它定义为了<code>objc_object *</code>类型，所以我们在用的时候就不用再加<code>*</code>号了。</p>
<p>那类又是如何定义的呢？在<code>Project Headers/objc-runtime-new.h</code>中找到：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> objc_class : objc_object &#123;</span><br><span class="line">    <span class="comment">// Class ISA;</span></span><br><span class="line">    Class superclass;</span><br><span class="line">    <span class="keyword">cache_t</span> cache;             <span class="comment">// formerly cache pointer and vtable</span></span><br><span class="line">    <span class="keyword">class_data_bits_t</span> bits;    <span class="comment">// class_rw_t * plus custom rr/alloc flags</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">class_rw_t</span> *data() &#123; </span><br><span class="line">        return bits.data();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">setData</span><span class="params">(class_rw_t *newData)</span> </span>&#123;</span><br><span class="line">        bits.setData(newData);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//此处略去其余部分，详细的可以看源代码</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="keyword">class_rw_t</span> &#123;</span><br><span class="line">    <span class="comment">// Be warned that Symbolication knows the layout of this structure.</span></span><br><span class="line">    <span class="keyword">uint32_t</span> flags;</span><br><span class="line">    <span class="keyword">uint32_t</span> version;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">class_ro_t</span> *ro;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">method_array_t</span> methods;</span><br><span class="line">    <span class="keyword">property_array_t</span> properties;</span><br><span class="line">    <span class="keyword">protocol_array_t</span> protocols;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//此处略去其余部分，详细的可以看源代码</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>所以类也是一个结构体指针，其中包含了描述它的实例对象的一切内容，如它的实例对象拥有的属性、能够调用的方法、遵循的协议等等。而<code>objc_class</code>又继承自<code>objc_object</code>，所以类其实也是对象，也包含了一个<code>isa</code>指针，指向了它所属的类。与普通的实例对象不同的是，类对象还有超类<code>superclass</code>。</p>
<h3 id="类的层次结构"><a href="#类的层次结构" class="headerlink" title="类的层次结构"></a>类的层次结构</h3><p>那么类对象的<code>isa</code>指针又指向了谁呢？<code>struct objc_class</code>中还有如下定义：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">bool isMetaClass() &#123;</span><br><span class="line">    assert(<span class="keyword">this</span>);</span><br><span class="line">    assert(isRealized());</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">data</span>()-&gt;ro-&gt;flags &amp; RO_META;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// NOT identical to this-&gt;ISA when this is a metaclass</span></span><br><span class="line">Class getMeta() &#123;</span><br><span class="line">    <span class="keyword">if</span> (isMetaClass()) <span class="keyword">return</span> (Class)<span class="keyword">this</span>;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">return</span> <span class="keyword">this</span>-&gt;ISA();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">bool isRootClass() &#123;</span><br><span class="line">     <span class="keyword">return</span> superclass == nil;</span><br><span class="line">&#125;</span><br><span class="line">bool isRootMetaclass() &#123;</span><br><span class="line">     <span class="keyword">return</span> ISA() == (Class)<span class="keyword">this</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里又出现了几个类：元类、根类与根元类，并且根类的超类为nil，根元类的<code>isa</code>指针指向了自己。在<code>Source/objc-runtime-new.mm</code>中可以找到他们是如何关联起来的。</p>
<figure class="highlight xl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">Class objc_allocateClassPair(Class superclass, const char *<span class="keyword">name</span>, </span><br><span class="line">                             size_t extraBytes)</span><br><span class="line">&#123;</span><br><span class="line">	 <span class="comment">// 类和元类是一一对应的，有一个类就有一个对应的元类</span></span><br><span class="line">    Class cls, meta;</span><br><span class="line"></span><br><span class="line">    mutex_locker_t lock(runtimeLock);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Fail if the class name is in use.</span></span><br><span class="line">    <span class="comment">// Fail if the superclass isn't kosher.</span></span><br><span class="line">    <span class="keyword">if</span> (getClass(<span class="keyword">name</span>)  ||  !verifySuperclass(superclass, <span class="literal">true</span><span class="comment">/*rootOK*/</span>)) &#123;</span><br><span class="line">        return <span class="literal">nil</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Allocate new classes.</span></span><br><span class="line">    cls  = alloc_class_for_subclass(superclass, extraBytes);</span><br><span class="line">    meta = alloc_class_for_subclass(superclass, extraBytes);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// fixme mangle the name if it looks swift-y?</span></span><br><span class="line">    objc_initializeClassPair_internal(superclass, <span class="keyword">name</span>, cls, meta);</span><br><span class="line"></span><br><span class="line">    return cls;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">static void objc_initializeClassPair_internal(Class superclass, const char *<span class="keyword">name</span>, Class cls, Class meta)</span><br><span class="line">&#123;</span><br><span class="line">	 <span class="comment">// 只列出了关键代码</span></span><br><span class="line">    <span class="comment">// Connect to superclasses and metaclasses</span></span><br><span class="line">    <span class="comment">// 类对象的`isa`指针指向了元类</span></span><br><span class="line">    <span class="function"><span class="title">cls</span>-&gt;</span>initClassIsa(meta);</span><br><span class="line">    <span class="keyword">if</span> (superclass) &#123;</span><br><span class="line">        <span class="comment">// 元类对象的`isa`指针指向了根元类，这一点从根类往下推，就可以得到了。</span></span><br><span class="line">        <span class="function"><span class="title">meta</span>-&gt;</span><span class="function"><span class="title">initClassIsa</span>(superclass-&gt;</span>ISA()-&gt;ISA());</span><br><span class="line">        <span class="comment">// 类的继承关系在元类中也有对应的继承关系</span></span><br><span class="line">        <span class="function"><span class="title">cls</span>-&gt;</span>superclass = superclass;</span><br><span class="line">        <span class="function"><span class="title">meta</span>-&gt;</span><span class="function"><span class="title">superclass</span> = superclass-&gt;</span>ISA();</span><br><span class="line">        </span><br><span class="line">        addSubclass(superclass, cls);</span><br><span class="line">        <span class="function"><span class="title">addSubclass</span>(superclass-&gt;</span>ISA(), meta);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123; <span class="comment">// superclass为nil，下面是该类为根类时的关系</span></span><br><span class="line">    	 <span class="comment">// 根元类对象的`isa`指针指向自己</span></span><br><span class="line">        <span class="function"><span class="title">meta</span>-&gt;</span>initClassIsa(meta); </span><br><span class="line">        <span class="comment">// 根类的超类为nil</span></span><br><span class="line">        <span class="function"><span class="title">cls</span>-&gt;</span>superclass = Nil;</span><br><span class="line">        <span class="comment">// 根元类继承自根类（NSObject）</span></span><br><span class="line">        <span class="function"><span class="title">meta</span>-&gt;</span>superclass = cls;</span><br><span class="line">        addRootClass(cls);</span><br><span class="line">        addSubclass(cls, meta);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>由此可以得到类的层次结构图了，例如Student继承Person，Person继承NSObject，则它们的层次结构图如下：</p>
<p><img src="/images/class_hierarchy.jpg"></p>
<p>像类描述了它的实例对象一样，元类描述了类对象，元类中定义了那些只有类对象能够调用的方法，也就是类方法。所以如果调用的实例方法，就沿着类的继承链从下往上找，如果是类方法，就沿着元类的继承链从下往上查找。</p>
<p>从上面的源码的实现过程其实也可以看出，无论我们在Objective-C中定义了什么对象，最终都会被编译成同一个结构体指针类型，只要在运行时改变<code>isa</code>指针就改变了它所属的类。对于类也是，我们甚至可以在运行时创建一个类。所以对于Objective-C语言来说它是动态的，但是到了C/C++层面，就是静态的了，我们不可能在运行时，创建一个<code>struct</code>。</p>
<h3 id="用内省检查判断对象所属的类"><a href="#用内省检查判断对象所属的类" class="headerlink" title="用内省检查判断对象所属的类"></a>用内省检查判断对象所属的类</h3><p>NSObject提供了两个方法来判断对象所属的类：</p>
<figure class="highlight cos"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 判断一个对象是否是某个类的，或者任何继承自它的类的实例</span></span><br><span class="line">- (BOOL)isKindOfClass:(<span class="keyword">Class</span>)aClass<span class="comment">;</span></span><br><span class="line"><span class="comment">// 判断一个对象是否是某个类的实例</span></span><br><span class="line">- (BOOL)isMemberOfClass:(<span class="keyword">Class</span>)aClass<span class="comment">;</span></span><br></pre></td></tr></table></figure>
<p>例如：</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">NSMutableDictionary</span> *dict = [<span class="type">NSMutableDictionary</span> <span class="keyword">new</span>];</span><br><span class="line">[dict isMemberOfClass:[<span class="type">NSDictionary</span> <span class="class"><span class="keyword">class</span>]]</span>;  <span class="comment">///&lt; NO</span></span><br><span class="line">[dict isMemberOfClass:[<span class="type">NSMutableDictionary</span> <span class="class"><span class="keyword">class</span>]]</span>;  <span class="comment">///&lt; YES</span></span><br><span class="line">[dict isKindOfClass:[<span class="type">NSDictionary</span> <span class="class"><span class="keyword">class</span>]]</span>; <span class="comment">///&lt; YES</span></span><br><span class="line">[dict isKindOfClass:[<span class="type">NSArray</span> <span class="class"><span class="keyword">class</span>]]</span>;  <span class="comment">///&lt; NO</span></span><br></pre></td></tr></table></figure>
<h2 id="动态绑定"><a href="#动态绑定" class="headerlink" title="动态绑定"></a>动态绑定</h2><h3 id="消息是如何发送的"><a href="#消息是如何发送的" class="headerlink" title="消息是如何发送的"></a>消息是如何发送的</h3><p>当给一个对象发送一个消息时，哪个方法会被调用完全是在运行时决定的，这就是Objective-C所采用的动态绑定机制，这使得Objective-C真正是动态的。在OC中给一个对象发送消息通常像下面这样：</p>
<figure class="highlight gams"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">id returnValue = [someObject messageName:<span class="keyword">parameter</span>];</span><br></pre></td></tr></table></figure>
<p><img src="/images/message_invoked.png"></p>
<p>编译器会把上面的语句转换成一个C函数：<code>objc_msgSend</code>，在<code>Public Headers/message.h</code>中可以找到其定义，只摘出了关键代码：</p>
<figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">/* Basic Messaging Primitives</span><br><span class="line"> *</span><br><span class="line"> * On <span class="keyword">some</span> architectures, use objc_msgSend_stret <span class="keyword">for</span> <span class="keyword">some</span> struct <span class="literal">return</span> types.</span><br><span class="line"> * On <span class="keyword">some</span> architectures, use objc_msgSend_fpret <span class="keyword">for</span> <span class="keyword">some</span> float <span class="literal">return</span> types.</span><br><span class="line"> * On <span class="keyword">some</span> architectures, use objc_msgSend_fp2ret <span class="keyword">for</span> <span class="keyword">some</span> float <span class="literal">return</span> types.</span><br><span class="line"> *</span><br><span class="line"> * These functions must be cast <span class="keyword">to</span> an appropriate function pointer type </span><br><span class="line"> * <span class="keyword">before</span> being called. </span><br><span class="line"> */</span><br><span class="line"><span class="comment">#if !OBJC_OLD_DISPATCH_PROTOTYPES</span></span><br><span class="line">OBJC_EXPORT void</span><br><span class="line">objc_msgSend(void /* <span class="built_in">id</span> self, SEL op, ... */ )</span><br><span class="line">    OBJC_AVAILABLE(<span class="number">10.0</span>, <span class="number">2.0</span>, <span class="number">9.0</span>, <span class="number">1.0</span>, <span class="number">2.0</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">#else</span></span><br><span class="line">/** </span><br><span class="line"> * Sends a message <span class="keyword">with</span> a simple <span class="literal">return</span> value <span class="keyword">to</span> an instance <span class="keyword">of</span> a <span class="built_in">class</span>.</span><br><span class="line"> * </span><br><span class="line"> * @param self A pointer <span class="keyword">to</span> <span class="keyword">the</span> instance <span class="keyword">of</span> <span class="keyword">the</span> <span class="built_in">class</span> <span class="keyword">that</span> <span class="keyword">is</span> <span class="keyword">to</span> receive <span class="keyword">the</span> message.</span><br><span class="line"> * @param op The selector <span class="keyword">of</span> <span class="keyword">the</span> method <span class="keyword">that</span> handles <span class="keyword">the</span> message.</span><br><span class="line"> * @param ... </span><br><span class="line"> *   A variable argument <span class="built_in">list</span> containing <span class="keyword">the</span> arguments <span class="keyword">to</span> <span class="keyword">the</span> method.</span><br><span class="line"> * </span><br><span class="line"> * @<span class="literal">return</span> The <span class="literal">return</span> value <span class="keyword">of</span> <span class="keyword">the</span> method.</span><br><span class="line"> * </span><br><span class="line"> * ...</span><br><span class="line"> */</span><br><span class="line">OBJC_EXPORT <span class="built_in">id</span> _Nullable</span><br><span class="line">objc_msgSend(<span class="built_in">id</span> _Nullable self, SEL _Nonnull op, ...)</span><br><span class="line">    OBJC_AVAILABLE(<span class="number">10.0</span>, <span class="number">2.0</span>, <span class="number">9.0</span>, <span class="number">1.0</span>, <span class="number">2.0</span>);</span><br><span class="line"><span class="comment">#endif</span></span><br></pre></td></tr></table></figure>
<p><code>OBJC_OLD_DISPATCH_PROTOTYPES</code>这里是一个编译选项，详细的可以看<a href="https://www.jianshu.com/p/e5aef096f967" target="_blank" rel="external">这篇文章</a>。如果没有开启就会转换成if中的写法，注释中的<code>These functions must be cast to an appropriate function pointer type before being called.</code>告诉我们需要在调用之前强转成合适的函数指针类型。上面的OC方法调用会被转成如下：</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">SEL sel = <span class="keyword">@selector</span>(messageName:)</span><br><span class="line"><span class="keyword">id</span> returnValue = ((<span class="keyword">id</span>(*)(<span class="keyword">id</span>, SEL))objc_msgSend)(someObject, sel);</span><br></pre></td></tr></table></figure>
<p>如果开启了会转换成else中的写法，此时上面的OC方法调用会被转成如下：</p>
<figure class="highlight armasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SEL </span><span class="keyword">sel </span>= <span class="comment">@selector(messageName:)</span></span><br><span class="line"><span class="symbol">id</span> returnValue = objc_msgSend(someObject, <span class="keyword">sel);</span></span><br></pre></td></tr></table></figure>
<p><code>objc_msgSend</code>的实现是用汇编写的，不同的架构函数体内部的写法也不同，但做的事情大致一样，我们这里看一下<code>Source/objc-msg-i386.s</code>里的实现：</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="markdown">/<span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="emphasis">***</span></span><br><span class="line"> *</span><br><span class="line"> * id objc<span class="emphasis">_msgSend(id self, SEL	_</span>cmd,...);</span><br><span class="line"> *</span><br><span class="line"> <span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="emphasis">***</span>/</span></span></span><br><span class="line"></span><br><span class="line">	ENTRY	_objc_msgSend</span><br><span class="line">	CALL_MCOUNTER</span><br><span class="line"></span><br><span class="line"><span class="comment">// load receiver and selector</span></span><br><span class="line">	movl   selector(%esp), %ecx</span><br><span class="line">	movl	self(%esp), %eax</span><br><span class="line"></span><br><span class="line"><span class="comment">// check whether receiver is nil </span></span><br><span class="line">	testl	%eax, %eax</span><br><span class="line">	je	LMsgSendNilSelf</span><br><span class="line"></span><br><span class="line"><span class="comment">// receiver (in %eax) is non-nil: search the cache</span></span><br><span class="line">LMsgSendReceiverOk:</span><br><span class="line">	movl	isa(%eax), %edx		<span class="comment">// class = self-&gt;isa</span></span><br><span class="line">	CacheLookup WORD_RETURN, MSG_SEND, LMsgSendCacheMiss</span><br><span class="line">	xor	%edx, %edx		<span class="comment">// set nonstret for msgForward_internal</span></span><br><span class="line">	jmp	*%eax</span><br><span class="line"></span><br><span class="line"><span class="comment">// cache miss: go search the method lists</span></span><br><span class="line">LMsgSendCacheMiss:</span><br><span class="line">	MethodTableLookup WORD_RETURN, MSG_SEND</span><br><span class="line">	xor	%edx, %edx		<span class="comment">// set nonstret for msgForward_internal</span></span><br><span class="line">	jmp	*%eax			   <span class="comment">// goto *imp</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// message sent to nil: redirect to nil receiver, if any</span></span><br><span class="line">LMsgSendNilSelf:</span><br><span class="line">	<span class="comment">// %eax is already zero</span></span><br><span class="line">	movl	$<span class="number">0</span>,%edx</span><br><span class="line">	xorps	%xmm0, %xmm0</span><br><span class="line">LMsgSendDone:</span><br><span class="line">	ret</span><br><span class="line"></span><br><span class="line"><span class="comment">// guaranteed non-nil entry point (disabled for now)</span></span><br><span class="line"><span class="comment">// .globl _objc_msgSendNonNil</span></span><br><span class="line"><span class="comment">// _objc_msgSendNonNil:</span></span><br><span class="line"><span class="comment">// 	movl	self(%esp), %eax</span></span><br><span class="line"><span class="comment">// 	jmp     LMsgSendReceiverOk</span></span><br><span class="line"></span><br><span class="line">LMsgSendExit:</span><br><span class="line">	END_ENTRY	_objc_msgSend</span><br></pre></td></tr></table></figure>
<p>通过注释可以看出，<code>objc_msgSend</code>根据<code>receiver</code>和<code>selector</code>，要找到一个可以跳转到的<code>imp</code>指针。</p>
<p>那这个<code>imp</code>指针又是什么呢？在<code>Public Headers/objc.h</code>可以找到对其的定义：</p>
<figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// A pointer to the function of a method implementation. </span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> !OBJC_OLD_DISPATCH_PROTOTYPES</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">void</span> (*IMP)(<span class="keyword">void</span> <span class="comment">/* id, SEL, ... */</span> ); </span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line"><span class="keyword">typedef</span> id _Nullable (*IMP)(id _Nonnull, SEL _Nonnull, ...); </span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br></pre></td></tr></table></figure>
<p>由此可知，<code>IMP</code>是一个指向函数的指针，这个函数就是OC里定义的方法的实现。所以<code>objc_msgSend</code>找到合适的<code>IMP</code>，就可以通过<code>IMP</code>去真正地执行方法了。可以看到<code>IMP</code>和<code>objc_msgSend</code>的使用几乎一样，如何我们能在编码时就很确定要调用哪个方法，就可以通过NSObject的实例方法<code>methodForSelector</code>来得到<code>IMP</code>，然后直接执行了，省去了<code>objc_msgSend</code>的查找过程。</p>
<p>从这里也可以看到，其实可以在运行时给类添加一个<code>IMP</code>，也就添加了一个方法，或者交换两个方法的<code>IMP</code>，那这个两个方法的方法体就可以交换了。也就是说，方法A和方法B的<code>IMP</code>指向交换，那当调用A时，实际执行的是B中的内容。所以完全可以动态地控制OC的方法。</p>
<p>Runtime提供了很多方法来直接操作类/实例对象/方法/属性等等，可以在<code>Public Headers/runtime.h</code>中查看。但是为了代码的可读性，以及避免少出错，还是优先使用OC给我们封装的上层方法。</p>
<h3 id="消息转发"><a href="#消息转发" class="headerlink" title="消息转发"></a>消息转发</h3><p>OC通过封装Runtime中的一些方法，在NSObject中给我们提供了一系列方法，可以在运行时灵活地处理那些在定义类时还没有给到的方法。这里分3个阶段来给开发者处理找不到的方法：</p>
<ol>
<li>首先会调用下面其中之一的方法来询问是否给对象的类添加了实例/类方法，如果返回YES，会重新给对象发一次消息，后面的转发流程就不走了。用<code>@dynamic</code>实现给属性动态添加getter/setter方法就可以在此处，通过<code>class_addMethod</code>来添加，</li>
</ol>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">+ (<span class="selector-tag">BOOL</span>)<span class="selector-tag">resolveClassMethod</span><span class="selector-pseudo">:(SEL)sel</span>;</span><br><span class="line">+ (<span class="selector-tag">BOOL</span>)<span class="selector-tag">resolveInstanceMethod</span><span class="selector-pseudo">:(SEL)sel</span></span><br></pre></td></tr></table></figure>
<ol>
<li>如果上面的方法返回了NO，就会接着执行下面的方法，找到新的消息接收者。返回值是新的<code>receiver</code>。</li>
</ol>
<figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">- <span class="params">(id)</span>forwardingTargetForSelector:<span class="params">(SEL)</span>aSelector;</span><br></pre></td></tr></table></figure>
<ol>
<li>如果上面的方法返回了nil，就会走到下面的方法，将整个消息完整的转发出去。在<code>NSInvocation</code>被创建之前，需要一个<code>NSMethodSignature</code>，所以<code>methodSignatureForSelector</code>会被调用。如果该方法是当前对象没有直接实现的，或者需要它的代理也能去处理，则需要重写这个方法，给一个新的<code>NSMethodSignature</code>。多路代理正是这样实现的。</li>
</ol>
<figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">- <span class="params">(void)</span>forwardInvocation:<span class="params">(NSInvocation *)</span>anInvocation;</span><br></pre></td></tr></table></figure>
<p>经过了上面3个阶段依旧没有找到消息要怎么被处理，就抛错了。上面的过程可以用图表示如下：</p>
<p><img src="/images/message_forwarding.jpg"></p>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p><strong>[1]</strong> <a href="https://onevcat.com/2012/04/objective-c-runtime/" target="_blank" rel="external">https://onevcat.com/2012/04/objective-c-runtime/</a></p>
<p><strong>[2]</strong> <a href="https://blog.csdn.net/hou_manager/article/details/79373616" target="_blank" rel="external">https://blog.csdn.net/hou_manager/article/details/79373616</a></p>
<p><strong>[3]</strong>《Effective Objective-C 2.0》</p>
<div class="note info"><p><strong>本文作者：</strong>意林<br><strong>本文链接：</strong><a href="http://www.shinancao.cn/2019/06/01/iOS-Runtime-1" target="_blank" rel="external">http://www.shinancao.cn/2019/06/01/iOS-Runtime-1</a><br><strong>版权声明：</strong>本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/3.0/" target="_blank" rel="external">CC BY-NC-SA 3.0</a> 许可协议。转载请注明出处！</p>
</div>
      
    </div>

    <div>
      
        

      
    </div>

    <div>
      
        

      
    </div>

    <div>
      
        

      
    </div>

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/Objective-C/" rel="tag"># Objective-C</a>
          
            <a href="/tags/Runtime/" rel="tag"># Runtime</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2019/05/07/iOS-EffectiveObjC-2/" rel="next" title="《Effective Objective-C 2.0》——Object, Protocol and Categories  ">
                <i class="fa fa-chevron-left"></i> 《Effective Objective-C 2.0》——Object, Protocol and Categories  
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2019/06/03/iOS-clang-1/" rel="prev" title="如何看clang编译后的C语言代码  ">
                如何看clang编译后的C语言代码   <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          
  <div class="comments" id="comments">
    
      <div id="gitment_container"></div>
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap" >
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/images/avatar.jpg"
               alt="意林" />
          <p class="site-author-name" itemprop="name">意林</p>
           
              <p class="site-description motion-element" itemprop="description"></p>
           
        </div>
        <nav class="site-state motion-element">

          
            <div class="site-state-item site-state-posts">
              <a href="/archives/">
                <span class="site-state-item-count">54</span>
                <span class="site-state-item-name">日志</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-categories">
              <a href="/categories/index.html">
                <span class="site-state-item-count">11</span>
                <span class="site-state-item-name">分类</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-tags">
              <a href="/tags/index.html">
                <span class="site-state-item-count">83</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/shinancao" target="_blank" rel="external nofollow" title="GitHub">
                  
                  GitHub
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://weibo.com/3178558825/profile?topnav=1&wvr=6&is_all=1" target="_blank" rel="external nofollow" title="微博">
                  
                  微博
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="https://www.douban.com/people/150971507/" target="_blank" rel="external nofollow" title="豆瓣">
                  
                  豆瓣
                </a>
              </span>
            
          
        </div>

        
        

        
        

        


      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#动态类型"><span class="nav-number">1.</span> <span class="nav-text">动态类型</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#类和对象的原型"><span class="nav-number">1.1.</span> <span class="nav-text">类和对象的原型</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#类的层次结构"><span class="nav-number">1.2.</span> <span class="nav-text">类的层次结构</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#用内省检查判断对象所属的类"><span class="nav-number">1.3.</span> <span class="nav-text">用内省检查判断对象所属的类</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#动态绑定"><span class="nav-number">2.</span> <span class="nav-text">动态绑定</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#消息是如何发送的"><span class="nav-number">2.1.</span> <span class="nav-text">消息是如何发送的</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#消息转发"><span class="nav-number">2.2.</span> <span class="nav-text">消息转发</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#参考"><span class="nav-number">3.</span> <span class="nav-text">参考</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">意林</span>
</div>


<div class="powered-by">
  由 <a class="theme-link" href="https://hexo.io" rel="external nofollow">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next" rel="external nofollow">
    NexT.Mist
  </a>
</div>


        

        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.1"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.1"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.1"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.1"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.1"></script>



  


  




	





  





  






	
		
		
		
		<link rel="stylesheet" href="https://imsun.github.io/gitment/style/default.css">
		<script src="https://imsun.github.io/gitment/dist/gitment.browser.js"></script>
		<script>
			var gitment = new Gitment({
			  //id: '页面 ID',
			  owner: 'shinancao',
			  repo: 'shinancao.github.io',
			  oauth: {
				client_id: 'd9ac25dfb2084f02efb1',
				client_secret: '7b127bf1c8bccb72ea55c1220c0db3d3e505672e'
			  }
			});
			gitment.render('gitment_container');
		</script>
	


  





  

  
<script>
(function(){
    var bp = document.createElement('script');
    var curProtocol = window.location.protocol.split(':')[0];
    if (curProtocol === 'https') {
        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';        
    }
    else {
        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
    }
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
})();
</script>


  

  

  

  

</body>
</html>
