<!DOCTYPE html>



  


<html class="theme-next mist use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  
    
      
    

    
  

  

  
    
      
    

    
  

  
    
      
    

    
  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Monda:300,300italic,400,400italic,700,700italic|Roboto Slab:300,300italic,400,400italic,700,700italic|Lobster Two:300,300italic,400,400italic,700,700italic|PT Mono:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.1" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Objective-C,clang," />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.png?v=5.1.1" />






<meta name="description" content="这是一篇比较轻松的文章，说一说clang编译后的代码怎么看。clang编译后的是C++的源代码，但其实也仅是用到了struct结构，其本质是C语言源代码，所以标题里就写“C语言代码”了。10多行的代码在编译之后能达到上万行代码，如果是第一次看，还是会有点懵的，所以记录一下要如何找到自己想要的核心代码，以便有小伙伴想要了解这块时，少走一点弯路。">
<meta property="og:type" content="article">
<meta property="og:title" content="如何看clang编译后的C语言代码  ">
<meta property="og:url" content="http://shinancao.github.io/2019/06/03/iOS-clang-1/index.html">
<meta property="og:site_name" content="意林的小站">
<meta property="og:description" content="这是一篇比较轻松的文章，说一说clang编译后的代码怎么看。clang编译后的是C++的源代码，但其实也仅是用到了struct结构，其本质是C语言源代码，所以标题里就写“C语言代码”了。10多行的代码在编译之后能达到上万行代码，如果是第一次看，还是会有点懵的，所以记录一下要如何找到自己想要的核心代码，以便有小伙伴想要了解这块时，少走一点弯路。">
<meta property="og:updated_time" content="2019-07-07T10:00:14.773Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="如何看clang编译后的C语言代码  ">
<meta name="twitter:description" content="这是一篇比较轻松的文章，说一说clang编译后的代码怎么看。clang编译后的是C++的源代码，但其实也仅是用到了struct结构，其本质是C语言源代码，所以标题里就写“C语言代码”了。10多行的代码在编译之后能达到上万行代码，如果是第一次看，还是会有点懵的，所以记录一下要如何找到自己想要的核心代码，以便有小伙伴想要了解这块时，少走一点弯路。">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Mist',
    sidebar: {"position":"left","display":"post","offset":12,"offset_float":0,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://shinancao.github.io/2019/06/03/iOS-clang-1/"/>





  <title>如何看clang编译后的C语言代码   | 意林的小站</title>
  














</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">意林的小站</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <h1 class="site-subtitle" itemprop="description">Be a cool girl ~</h1>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://shinancao.github.io/2019/06/03/iOS-clang-1/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="意林">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="意林的小站">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">如何看clang编译后的C语言代码  </h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-06-03T06:40:32+08:00">
                2019-06-03
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/iOS/" itemprop="url" rel="index">
                    <span itemprop="name">iOS</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/iOS/Objective-C/" itemprop="url" rel="index">
                    <span itemprop="name">Objective-C</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>这是一篇比较轻松的文章，说一说clang编译后的代码怎么看。clang编译后的是C++的源代码，但其实也仅是用到了struct结构，其本质是C语言源代码，所以标题里就写“C语言代码”了。10多行的代码在编译之后能达到上万行代码，如果是第一次看，还是会有点懵的，所以记录一下要如何找到自己想要的核心代码，以便有小伙伴想要了解这块时，少走一点弯路。</p>
<a id="more"></a>
<h2 id="准备OC代码，并编译"><a href="#准备OC代码，并编译" class="headerlink" title="准备OC代码，并编译"></a>准备OC代码，并编译</h2><p>OC的代码写的越多，引用的Framework越多，编译后的代码量也会越多，就越影响自己阅读代码。我这里就想看一下编译后的OC类、实例对象、方法等等是怎样的关联，所以只引用了<code>&lt;Foundation/Foundation.h&gt;</code>就够用了。完整的OC代码如下，一会将编译这份代码：</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// main.m</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#import <span class="meta-string">&lt;Foundation/Foundation.h&gt;</span></span></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">EOCObject</span> : <span class="title">NSObject</span></span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">copy</span>) <span class="built_in">NSString</span> *name;</span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">EOCObject</span></span></span><br><span class="line">- (<span class="keyword">void</span>)work &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"I'm working!"</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> main(<span class="keyword">int</span> argc, <span class="keyword">char</span> * argv[]) &#123;</span><br><span class="line">    <span class="keyword">@autoreleasepool</span> &#123;</span><br><span class="line">        EOCObject *obj = [[EOCObject alloc] init];</span><br><span class="line">        [obj work];</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;  <span class="comment">// 为了简便，这里可以直接返回0。</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>现在打开终端，执行如下命令：</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">clang</span> <span class="selector-tag">-rewrite-objc</span> <span class="selector-tag">main</span><span class="selector-class">.m</span></span><br></pre></td></tr></table></figure>
<p>警告可以忽略，没有报<code>error</code>就可以，然后在与<code>main.m</code>同一个目录下会生成一个<code>main.cpp</code>文件。</p>
<p>如果引用了其他Framework包，比如<code>&lt;UIKit/UIKit.h&gt;</code>，可以指定使用模拟器中的SDK编译：</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">xcrun</span> <span class="selector-tag">-sdk</span> <span class="selector-tag">iphonesimulator</span> <span class="selector-tag">clang</span> <span class="selector-tag">-rewrite-objc</span> <span class="selector-tag">-fobjc-arc</span> <span class="selector-tag">main</span><span class="selector-class">.m</span></span><br></pre></td></tr></table></figure>
<h2 id="分析生成的-cpp文件"><a href="#分析生成的-cpp文件" class="headerlink" title="分析生成的.cpp文件"></a>分析生成的.cpp文件</h2><p>现在打开刚才生成的<code>main.cpp</code>文件，从上面往下看。上面定义了一堆基本类型结构，是编译任何一个<code>.m</code>文件都会有的。</p>
<p>首先声明了<code>objc_selector</code>，也就是<code>SEL</code>。还有<code>objc_class</code>，OC中类的struct结构。然后是超类结构和定义<code>Protocol</code>。</p>
<figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> __OBJC2__</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> __OBJC2__</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="keyword">struct</span> objc_selector; <span class="keyword">struct</span> objc_class;</span><br><span class="line"><span class="keyword">struct</span> __rw_objc_super &#123; </span><br><span class="line">	<span class="keyword">struct</span> objc_object *object; </span><br><span class="line">	<span class="keyword">struct</span> objc_object *superClass; </span><br><span class="line">	__rw_objc_super(<span class="keyword">struct</span> objc_object *o, <span class="keyword">struct</span> objc_object *s) : object(o), superClass(s) &#123;&#125; </span><br><span class="line">&#125;;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> _REWRITER_typedef_Protocol</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> objc_object Protocol;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _REWRITER_typedef_Protocol</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br></pre></td></tr></table></figure>
<p>接着导入需要的基本方法。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> __OBJC_RW_DLLIMPORT extern</span></span><br><span class="line">__<span class="function">OBJC_RW_DLLIMPORT <span class="keyword">void</span> <span class="title">objc_msgSend</span><span class="params">(<span class="keyword">void</span>)</span></span>;</span><br><span class="line">__<span class="function">OBJC_RW_DLLIMPORT <span class="keyword">void</span> <span class="title">objc_msgSendSuper</span><span class="params">(<span class="keyword">void</span>)</span></span>;</span><br><span class="line">__<span class="function">OBJC_RW_DLLIMPORT <span class="keyword">void</span> <span class="title">objc_msgSend_stret</span><span class="params">(<span class="keyword">void</span>)</span></span>;</span><br><span class="line">__<span class="function">OBJC_RW_DLLIMPORT <span class="keyword">void</span> <span class="title">objc_msgSendSuper_stret</span><span class="params">(<span class="keyword">void</span>)</span></span>;</span><br><span class="line">__<span class="function">OBJC_RW_DLLIMPORT <span class="keyword">void</span> <span class="title">objc_msgSend_fpret</span><span class="params">(<span class="keyword">void</span>)</span></span>;</span><br><span class="line">__<span class="function">OBJC_RW_DLLIMPORT <span class="keyword">struct</span> objc_class *<span class="title">objc_getClass</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *)</span></span>;</span><br><span class="line">__<span class="function">OBJC_RW_DLLIMPORT <span class="keyword">struct</span> objc_class *<span class="title">class_getSuperclass</span><span class="params">(<span class="keyword">struct</span> objc_class *)</span></span>;</span><br><span class="line">__<span class="function">OBJC_RW_DLLIMPORT <span class="keyword">struct</span> objc_class *<span class="title">objc_getMetaClass</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *)</span></span>;</span><br><span class="line">__<span class="function">OBJC_RW_DLLIMPORT <span class="keyword">void</span> <span class="title">objc_exception_throw</span><span class="params">( <span class="keyword">struct</span> objc_object *)</span></span>;</span><br><span class="line">__<span class="function">OBJC_RW_DLLIMPORT <span class="keyword">int</span> <span class="title">objc_sync_enter</span><span class="params">( <span class="keyword">struct</span> objc_object *)</span></span>;</span><br><span class="line">__<span class="function">OBJC_RW_DLLIMPORT <span class="keyword">int</span> <span class="title">objc_sync_exit</span><span class="params">( <span class="keyword">struct</span> objc_object *)</span></span>;</span><br><span class="line">__<span class="function">OBJC_RW_DLLIMPORT Protocol *<span class="title">objc_getProtocol</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *)</span></span>;</span><br></pre></td></tr></table></figure>
<p>然后定义了<code>NSUInteger</code>的类型。</p>
<figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> _WIN64</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span>  _WIN_NSUInteger;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">unsigned</span> <span class="keyword">int</span> _WIN_NSUInteger;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br></pre></td></tr></table></figure>
<p>接着是对枚举的定义。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> __FASTENUMERATIONSTATE</span></span><br><span class="line"><span class="keyword">struct</span> __objcFastEnumerationState &#123;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> state;</span><br><span class="line">	<span class="keyword">void</span> **itemsPtr;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> *mutationsPtr;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> extra[<span class="number">5</span>];</span><br><span class="line">&#125;;</span><br><span class="line">__<span class="function">OBJC_RW_DLLIMPORT <span class="keyword">void</span> <span class="title">objc_enumerationMutation</span><span class="params">(<span class="keyword">struct</span> objc_object *)</span></span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> __FASTENUMERATIONSTATE</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br></pre></td></tr></table></figure>
<p>然后是对常量字符串的定义，它的<code>isa</code>取值为<code>__CFConstantStringClassReference</code>，代码中出现的所有常量字符串类型都会转换成该类型，并且放在内存中的数据区域（.data区）。</p>
<figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> __NSCONSTANTSTRINGIMPL</span></span><br><span class="line"><span class="keyword">struct</span> __NSConstantStringImpl &#123;</span><br><span class="line">  <span class="keyword">int</span> *isa;</span><br><span class="line">  <span class="keyword">int</span> flags;</span><br><span class="line">  <span class="keyword">char</span> *str;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> _WIN64</span></span><br><span class="line">  <span class="keyword">long</span> <span class="keyword">long</span> length;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line">  <span class="keyword">long</span> length;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">&#125;;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CF_EXPORT_CONSTANT_STRING</span></span><br><span class="line"><span class="keyword">extern</span> <span class="string">"C"</span> __declspec(dllexport) <span class="keyword">int</span> __CFConstantStringClassReference[];</span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line">__OBJC_RW_DLLIMPORT <span class="keyword">int</span> __CFConstantStringClassReference[];</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> __NSCONSTANTSTRINGIMPL</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br></pre></td></tr></table></figure>
<p>接着是对<code>Block</code>的定义，可以看到<code>Block</code>实际上是<code>void *</code>类型，它的取值这里只导入了两个<code>_NSConcreteGlobalBlock</code>和<code>_NSConcreteStackBlock</code>，其实还有一个<code>_NSConcreteMallocBlock</code>。<code>_Block_object_assign</code>是对一个<code>Block</code>进行copy时调用的，<code>_Block_object_dispose</code>就是销毁的时候了。</p>
<figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> BLOCK_IMPL</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> BLOCK_IMPL</span></span><br><span class="line"><span class="keyword">struct</span> __block_impl &#123;</span><br><span class="line">  <span class="keyword">void</span> *isa;</span><br><span class="line">  <span class="keyword">int</span> Flags;</span><br><span class="line">  <span class="keyword">int</span> Reserved;</span><br><span class="line">  <span class="keyword">void</span> *FuncPtr;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="comment">// Runtime copy/destroy helper functions (from Block_private.h)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> __OBJC_EXPORT_BLOCKS</span></span><br><span class="line"><span class="keyword">extern</span> <span class="string">"C"</span> __declspec(dllexport) <span class="keyword">void</span> _Block_object_assign(<span class="keyword">void</span> *, <span class="keyword">const</span> <span class="keyword">void</span> *, <span class="keyword">const</span> <span class="keyword">int</span>);</span><br><span class="line"><span class="keyword">extern</span> <span class="string">"C"</span> __declspec(dllexport) <span class="keyword">void</span> _Block_object_dispose(<span class="keyword">const</span> <span class="keyword">void</span> *, <span class="keyword">const</span> <span class="keyword">int</span>);</span><br><span class="line"><span class="keyword">extern</span> <span class="string">"C"</span> __declspec(dllexport) <span class="keyword">void</span> *_NSConcreteGlobalBlock[<span class="number">32</span>];</span><br><span class="line"><span class="keyword">extern</span> <span class="string">"C"</span> __declspec(dllexport) <span class="keyword">void</span> *_NSConcreteStackBlock[<span class="number">32</span>];</span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line">__OBJC_RW_DLLIMPORT <span class="keyword">void</span> _Block_object_assign(<span class="keyword">void</span> *, <span class="keyword">const</span> <span class="keyword">void</span> *, <span class="keyword">const</span> <span class="keyword">int</span>);</span><br><span class="line">__OBJC_RW_DLLIMPORT <span class="keyword">void</span> _Block_object_dispose(<span class="keyword">const</span> <span class="keyword">void</span> *, <span class="keyword">const</span> <span class="keyword">int</span>);</span><br><span class="line">__OBJC_RW_DLLIMPORT <span class="keyword">void</span> *_NSConcreteGlobalBlock[<span class="number">32</span>];</span><br><span class="line">__OBJC_RW_DLLIMPORT <span class="keyword">void</span> *_NSConcreteStackBlock[<span class="number">32</span>];</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> __block</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> __weak</span></span><br></pre></td></tr></table></figure>
<p>下面是对OC中容器类型的定义。</p>
<figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#include &lt;stdarg.h&gt;</span></span><br><span class="line">struct __NSContainer_literal &#123;</span><br><span class="line">  void * *arr<span class="comment">;</span></span><br><span class="line">  __NSContainer_literal (unsigned int <span class="built_in">count</span>, ...) &#123;</span><br><span class="line">	va_list marker<span class="comment">;</span></span><br><span class="line">	va_start(marker, <span class="built_in">count</span>)<span class="comment">;</span></span><br><span class="line">	arr = new void *[<span class="built_in">count</span>]<span class="comment">;</span></span><br><span class="line">	for (unsigned i = <span class="number">0</span><span class="comment">; i &lt; count; i++)</span></span><br><span class="line">	  arr[i] = va_arg(marker, void *)<span class="comment">;</span></span><br><span class="line">	va_end( marker )<span class="comment">;</span></span><br><span class="line">  &#125;<span class="comment">;</span></span><br><span class="line">  ~__NSContainer_literal() &#123;</span><br><span class="line">	delete[] arr<span class="comment">;</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;<span class="comment">;</span></span><br></pre></td></tr></table></figure>
<p>接着是与<code>autoreleasePool</code>相关的方法导入和定义。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">extern</span> <span class="string">"C"</span> __declspec(dllimport) <span class="function"><span class="keyword">void</span> * <span class="title">objc_autoreleasePoolPush</span><span class="params">(<span class="keyword">void</span>)</span></span>;</span><br><span class="line"><span class="keyword">extern</span> <span class="string">"C"</span> __declspec(dllimport) <span class="function"><span class="keyword">void</span> <span class="title">objc_autoreleasePoolPop</span><span class="params">(<span class="keyword">void</span> *)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> __AtAutoreleasePool &#123;</span><br><span class="line">  __AtAutoreleasePool() &#123;atautoreleasepoolobj = objc_autoreleasePoolPush();&#125;</span><br><span class="line">  ~__AtAutoreleasePool() &#123;objc_autoreleasePoolPop(atautoreleasepoolobj);&#125;</span><br><span class="line">  <span class="keyword">void</span> * atautoreleasepoolobj;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>然后是定义一个宏，来计算struct结构中变量的偏移量。</p>
<figure class="highlight lisp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">#define __OFFSETOFIVAR__(<span class="name">TYPE</span>, MEMBER) ((<span class="name">long</span> long) &amp;((<span class="name">TYPE</span> *)0)-&gt;MEMBER)</span><br></pre></td></tr></table></figure>
<p>到此对OC中的一些基本结构的定义就结束了。下面一段是对我们自己写的代码中的字符串的定义。通过<code>section (&quot;__DATA, __cfstring&quot;)</code>可以看到，常量字符串放置在了内存中的数据区域。</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> __<span class="built_in">NSConstantStringImpl</span> __<span class="built_in">NSConstantStringImpl__var_folders_nx_dxppf5lj151119zfqd6lrc_m0000gn_T_main_obj_80f1ba_mi_0</span> __attribute__ ((section (<span class="string">"__DATA, __cfstring"</span>))) = &#123;__<span class="built_in">CFConstantStringClassReference</span>,<span class="number">0x000007c8</span>,<span class="string">"I'm working!"</span>,<span class="number">12</span>&#125;;</span><br></pre></td></tr></table></figure>
<p>接下来有很长一段的空行，然后应该是我们OC中导入的头文件的转换。可以直接跳过，这一部分对于分析我们自己的代码作用不是很大。全局搜索<code>#pragma clang assume_nonnull end</code>，最后一次出现的地方的下方就是对应我们上面写的OC代码的转换了。</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#ifndef _REWRITER_typedef_EOCObject</span></span><br><span class="line"><span class="meta">#define _REWRITER_typedef_EOCObject</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> objc_object EOCObject;</span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> &#123;&#125; _objc_exc_EOCObject;</span><br><span class="line"><span class="meta">#endif</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">extern</span> <span class="string">"C"</span> <span class="keyword">unsigned</span> <span class="keyword">long</span> OBJC_IVAR_$_EOCObject$_name;</span><br><span class="line"><span class="keyword">struct</span> EOCObject_I<span class="built_in">MPL</span> &#123;</span><br><span class="line">	<span class="keyword">struct</span> <span class="built_in">NSObject_IMPL</span> <span class="built_in">NSObject_IVARS</span>;</span><br><span class="line">	<span class="built_in">NSString</span> *__<span class="keyword">strong</span> _name;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// @property (nonatomic, copy) NSString *name;</span></span><br><span class="line"><span class="comment">/* @end */</span></span><br></pre></td></tr></table></figure>
<p>声明一个<code>struct objc_object</code>类型的变量<code>EOCObject</code>，已经定义它的内部变量<code>_name</code>。</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// @implementation EOCObject</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">void</span> _I_EOCObject_work(EOCObject * <span class="keyword">self</span>, SEL _cmd) &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>((<span class="built_in">NSString</span> *)&amp;__<span class="built_in">NSConstantStringImpl__var_folders_nx_dxppf5lj151119zfqd6lrc_m0000gn_T_main_obj_f18233_mi_0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="built_in">NSString</span> * _I_EOCObject_name(EOCObject * <span class="keyword">self</span>, SEL _cmd) &#123; <span class="keyword">return</span> (*(<span class="built_in">NSString</span> *__<span class="keyword">strong</span> *)((<span class="keyword">char</span> *)<span class="keyword">self</span> + OBJC_IVAR_$_EOCObject$_name)); &#125;</span><br><span class="line"><span class="keyword">extern</span> <span class="string">"C"</span> __declspec(dllimport) <span class="keyword">void</span> objc_setProperty (<span class="keyword">id</span>, SEL, <span class="keyword">long</span>, <span class="keyword">id</span>, <span class="keyword">bool</span>, <span class="keyword">bool</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">void</span> _I_EOCObject_setName_(EOCObject * <span class="keyword">self</span>, SEL _cmd, <span class="built_in">NSString</span> *name) &#123; objc_setProperty (<span class="keyword">self</span>, _cmd, __OFFSETOFIVAR__(<span class="keyword">struct</span> EOCObject, _name), (<span class="keyword">id</span>)name, <span class="number">0</span>, <span class="number">1</span>); &#125;</span><br><span class="line"><span class="comment">// @end</span></span><br></pre></td></tr></table></figure>
<p><code>EOCObject</code>中的3个函数实现，后面会用到此处的函数指针。</p>
<figure class="highlight lisp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">int main(<span class="name">int</span> argc, char * argv[]) &#123;</span><br><span class="line">    /* @autoreleasepool */ &#123; __AtAutoreleasePool __autoreleasepool; </span><br><span class="line">        EOCObject *obj = ((<span class="name">EOCObject</span> *(*)(<span class="name">id</span>, SEL))(<span class="name">void</span> *)objc_msgSend)((id)((EOCObject *(<span class="name">*</span>)(<span class="name">id</span>, SEL))(<span class="name">void</span> *)objc_msgSend)((id)objc_getClass("EOCObject"), sel_registerName("alloc")), sel_registerName("init"));</span><br><span class="line">        ((void (*)(<span class="name">id</span>, SEL))(<span class="name">void</span> *)objc_msgSend)((id)obj, sel_registerName("work"));</span><br><span class="line">        return 0;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>对应函数main中代码的转换，方法调用都转成了用<code>objc_msgSend</code>调用。因为<code>objc_msgSend</code>返回的是<code>void *</code>，所以在使用时需要对其强制转换，所以看起起来啰嗦了一些。把<code>((void (*)(id, SEL))(void *)objc_msgSend)</code>看成一个整体就好。</p>
<p>再接下来，又是一堆结构体的定义，包括<code>_prop_t</code>、<code>_objc_method</code>、<code>_protocol_t</code>、<code>_ivar_t</code>、<code>_class_ro_t</code>、<code>_class_t</code>、<code>_category_t</code>，这一段代码比较简单，不贴代码出来了，太长了…</p>
<p>然后就是对我们在OC中定义的对象的处理过程，给各种struct赋值的一个过程。仔细阅读可以对我们平时在写的OC代码有一个更清晰的认识。下面依次说一下这段里的每一部分。</p>
<figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">extern</span> <span class="string">"C"</span> <span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">int</span> OBJC_IVAR_$_EOCObject$_name __attribute__ ((used, section (<span class="string">"__DATA,__objc_ivar"</span>))) = __OFFSETOFIVAR__(<span class="keyword">struct</span> EOCObject, _name);</span><br></pre></td></tr></table></figure>
<p>利用上面的宏<strong>OFFSETOFIVAR</strong>计算<code>_name</code>的偏移量，赋值给变量<code>OBJC_IVAR_$_EOCObject$_name</code>，然后存在内存中的数据区域。</p>
<figure class="highlight crystal"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">static <span class="class"><span class="keyword">struct</span> /*<span class="title">_ivar_list_t</span>*/ &#123;</span></span><br><span class="line">	unsigned int entsize;  <span class="regexp">//</span> <span class="keyword">sizeof</span>(<span class="class"><span class="keyword">struct</span> <span class="title">_prop_t</span>)</span></span><br><span class="line">	unsigned int count;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">_ivar_t</span> <span class="title">ivar_list</span>[1];</span></span><br><span class="line">&#125; _OBJC_$_INSTANCE_VARIABLES_EOCObject __attribute__ ((used, section (<span class="string">"__DATA,__objc_const"</span>))) = &#123;</span><br><span class="line">	<span class="keyword">sizeof</span>(_ivar_t),</span><br><span class="line">	<span class="number">1</span>,</span><br><span class="line">	<span class="template-variable">&#123;&#123;(unsigned long int *)&amp;OBJC_IVAR_$_EOCObject$_name, <span class="string">"_name"</span>, <span class="string">"@\"NSString\""</span>, <span class="number">3</span>, <span class="number">8</span>&#125;&#125;</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>拿到<code>EOCObject</code>的内部成员变量信息，赋值给变量<code>_OBJC_$_INSTANCE_VARIABLES_EOCObject</code>，每个成员变量的信息存在了<code>_ivar_t</code>类型的数组<code>ivar_list</code>中。</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">struct</span> <span class="comment">/*_method_list_t*/</span> &#123;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> entsize;  <span class="comment">// sizeof(struct _objc_method)</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> method_count;</span><br><span class="line">	<span class="keyword">struct</span> _objc_method method_list[<span class="number">3</span>];</span><br><span class="line">&#125; _OBJC_$_I<span class="built_in">NSTANCE_METHODS_EOCObject</span> __attribute__ ((used, section (<span class="string">"__DATA,__objc_const"</span>))) = &#123;</span><br><span class="line">	<span class="keyword">sizeof</span>(_objc_method),</span><br><span class="line">	<span class="number">3</span>,</span><br><span class="line">	&#123;&#123;(<span class="keyword">struct</span> objc_selector *)<span class="string">"work"</span>, <span class="string">"v16@0:8"</span>, (<span class="keyword">void</span> *)_I_EOCObject_work&#125;,</span><br><span class="line">	&#123;(<span class="keyword">struct</span> objc_selector *)<span class="string">"name"</span>, <span class="string">"@16@0:8"</span>, (<span class="keyword">void</span> *)_I_EOCObject_name&#125;,</span><br><span class="line">	&#123;(<span class="keyword">struct</span> objc_selector *)<span class="string">"setName:"</span>, <span class="string">"v24@0:8@16"</span>, (<span class="keyword">void</span> *)_I_EOCObject_setName_&#125;&#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>拿到<code>EOCObject</code>的方法信息，赋值给变量<code>_OBJC_$_INSTANCE_METHODS_EOCObject</code>，每个方法的信息存在<code>_objc_method</code>类型的数组<code>method_list</code>中。<code>_objc_method</code>由方法的名字，如<code>(struct objc_selector *)&quot;work&quot;</code>，和方法类型，如<code>v16@0:8</code>（冒号前面表示返回值，后面表示参数），还有指向实际去执行的函数的指针，如<code>(void *)_I_EOCObject_work</code>，<code>_I_EOCObject_work</code>在main的上面定义过。</p>
<figure class="highlight crystal"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">static <span class="class"><span class="keyword">struct</span> /*<span class="title">_prop_list_t</span>*/ &#123;</span></span><br><span class="line">	unsigned int entsize;  <span class="regexp">//</span> <span class="keyword">sizeof</span>(<span class="class"><span class="keyword">struct</span> <span class="title">_prop_t</span>)</span></span><br><span class="line">	unsigned int count_of_properties;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">_prop_t</span> <span class="title">prop_list</span>[1];</span></span><br><span class="line">&#125; _OBJC_$_PROP_LIST_EOCObject __attribute__ ((used, section (<span class="string">"__DATA,__objc_const"</span>))) = &#123;</span><br><span class="line">	<span class="keyword">sizeof</span>(_prop_t),</span><br><span class="line">	<span class="number">1</span>,</span><br><span class="line">	<span class="template-variable">&#123;&#123;<span class="string">"name"</span>,<span class="string">"T@\"NSString\",C,N,V_name"</span>&#125;&#125;</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>拿到<code>EOCObject</code>定义在property中的属性信息，赋值给<code>_OBJC_$_PROP_LIST_EOCObject</code>，每个属性的信息存在<code>_prop_t</code>类型的数组<code>prop_list</code>中。</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">_class_ro_t</span></span> _OBJC_METACLASS_RO_$_EOCObject __attribute__ ((used, section (<span class="string">"__DATA,__objc_const"</span>))) = &#123;</span><br><span class="line">	<span class="number">1</span>, <span class="keyword">sizeof</span>(<span class="class"><span class="keyword">struct</span> <span class="title">_class_t</span></span>), <span class="keyword">sizeof</span>(<span class="class"><span class="keyword">struct</span> <span class="title">_class_t</span></span>), </span><br><span class="line">	(unsigned <span class="keyword">int</span>)<span class="number">0</span>, </span><br><span class="line">	<span class="number">0</span>, </span><br><span class="line">	<span class="string">"EOCObject"</span>,</span><br><span class="line">	<span class="number">0</span>, </span><br><span class="line">	<span class="number">0</span>, </span><br><span class="line">	<span class="number">0</span>, </span><br><span class="line">	<span class="number">0</span>, </span><br><span class="line">	<span class="number">0</span>, </span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>拿到<code>EOCObject</code>的元类信息，赋值给<code>_OBJC_METACLASS_RO_$_EOCObject</code>，可以看到<code>EOCObject</code>的元类也是<code>EOCObject</code>，但是方法列表等都是空的，因为我们没有在OC中给<code>EOCObject</code>定义类方法等。</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">_class_ro_t</span></span> _OBJC_CLASS_RO_$_EOCObject __attribute__ ((used, section (<span class="string">"__DATA,__objc_const"</span>))) = &#123;</span><br><span class="line">	<span class="number">0</span>, __OFFSETOFIVAR__(<span class="class"><span class="keyword">struct</span> <span class="title">EOCObject</span></span>, _name), <span class="keyword">sizeof</span>(<span class="class"><span class="keyword">struct</span> <span class="title">EOCObject_IMPL</span></span>), </span><br><span class="line">	(unsigned <span class="keyword">int</span>)<span class="number">0</span>, </span><br><span class="line">	<span class="number">0</span>, </span><br><span class="line">	<span class="string">"EOCObject"</span>,</span><br><span class="line">	(<span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">_method_list_t</span></span> *)&amp;_OBJC_$_INSTANCE_METHODS_EOCObject,</span><br><span class="line">	<span class="number">0</span>, </span><br><span class="line">	(<span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">_ivar_list_t</span></span> *)&amp;_OBJC_$_INSTANCE_VARIABLES_EOCObject,</span><br><span class="line">	<span class="number">0</span>, </span><br><span class="line">	(<span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">_prop_list_t</span></span> *)&amp;_OBJC_$_PROP_LIST_EOCObject,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>那到<code>EOCObject</code>类本身的一些信息，赋值给<code>_OBJC_CLASS_RO_$_EOCObject</code>，这里就把刚刚准备好的<code>_OBJC_$_INSTANCE_METHODS_EOCObject</code>、<code>_OBJC_$_INSTANCE_VARIABLES_EOCObject</code>、<code>_OBJC_$_PROP_LIST_EOCObject</code>关联了起来。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">extern</span> <span class="string">"C"</span> __declspec(dllimport) <span class="keyword">struct</span> <span class="keyword">_class_t</span> OBJC_METACLASS_$_NSObject;</span><br><span class="line"></span><br><span class="line"><span class="keyword">extern</span> <span class="string">"C"</span> __declspec(dllexport) <span class="keyword">struct</span> <span class="keyword">_class_t</span> OBJC_METACLASS_$_EOCObject __attribute__ ((used, section (<span class="string">"__DATA,__objc_data"</span>))) = &#123;</span><br><span class="line">	<span class="number">0</span>, <span class="comment">// &amp;OBJC_METACLASS_$_NSObject,</span></span><br><span class="line">	<span class="number">0</span>, <span class="comment">// &amp;OBJC_METACLASS_$_NSObject,</span></span><br><span class="line">	<span class="number">0</span>, <span class="comment">// (void *)&amp;_objc_empty_cache,</span></span><br><span class="line">	<span class="number">0</span>, <span class="comment">// unused, was (void *)&amp;_objc_empty_vtable,</span></span><br><span class="line">	&amp;_OBJC_METACLASS_RO_$_EOCObject,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">extern</span> <span class="string">"C"</span> __declspec(dllimport) <span class="keyword">struct</span> <span class="keyword">_class_t</span> OBJC_CLASS_$_NSObject;</span><br><span class="line"></span><br><span class="line"><span class="keyword">extern</span> <span class="string">"C"</span> __declspec(dllexport) <span class="keyword">struct</span> <span class="keyword">_class_t</span> OBJC_CLASS_$_EOCObject __attribute__ ((used, section (<span class="string">"__DATA,__objc_data"</span>))) = &#123;</span><br><span class="line">	<span class="number">0</span>, <span class="comment">// &amp;OBJC_METACLASS_$_EOCObject,</span></span><br><span class="line">	<span class="number">0</span>, <span class="comment">// &amp;OBJC_CLASS_$_NSObject,</span></span><br><span class="line">	<span class="number">0</span>, <span class="comment">// (void *)&amp;_objc_empty_cache,</span></span><br><span class="line">	<span class="number">0</span>, <span class="comment">// unused, was (void *)&amp;_objc_empty_vtable,</span></span><br><span class="line">	&amp;_OBJC_CLASS_RO_$_EOCObject,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p><code>_class_ro_t</code>只是存了类的基本信息，但是没有存它的<code>isa</code>指向，和它的父类，于是结构体<code>_class_t</code>又封装了一次，并且加上缓存。所以上面这段得到的就是元类<code>NSObject</code>、元类<code>EOCObject</code>、类<code>NSObject</code>、类<code>EOCObject</code>。</p>
<figure class="highlight lasso"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">static <span class="literal">void</span> OBJC_CLASS_SETUP_$_EOCObject(<span class="literal">void</span> ) &#123;</span><br><span class="line">	OBJC_METACLASS_$_EOCObject.isa = &amp;OBJC_METACLASS_$_NSObject;</span><br><span class="line">	OBJC_METACLASS_$_EOCObject.superclass = &amp;OBJC_METACLASS_$_NSObject;</span><br><span class="line">	OBJC_METACLASS_$_EOCObject.cache = &amp;_objc_empty_cache;</span><br><span class="line">	OBJC_CLASS_$_EOCObject.isa = &amp;OBJC_METACLASS_$_EOCObject;</span><br><span class="line">	OBJC_CLASS_$_EOCObject.superclass = &amp;OBJC_CLASS_$_NSObject;</span><br><span class="line">	OBJC_CLASS_$_EOCObject.cache = &amp;_objc_empty_cache;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>该方法就把上面的各种类之间的关系串起来了，元类<code>EOCObject</code>的<code>isa</code>和父类都指向元类<code>NSObject</code>，类<code>EOCObject</code>的<code>isa</code>指向元类<code>EOCObject</code>，它的父类指向类<code>NSObject</code>。</p>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">#pragma section(<span class="string">".objc_inithooks$B"</span>, <span class="keyword">long</span>, <span class="keyword">read</span>, <span class="keyword">write</span>)</span><br><span class="line">__declspec(allocate(<span class="string">".objc_inithooks$B"</span>)) <span class="keyword">static</span> <span class="keyword">void</span> *OBJC_CLASS_SETUP[] = &#123;</span><br><span class="line">	(<span class="keyword">void</span> *)&amp;OBJC_CLASS_SETUP_$_EOCObject,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>此处应该是一个钩子，在初始化时执行上面的<code>OBJC_CLASS_SETUP_$_EOCObject</code>函数，对类进行设置。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">struct</span> <span class="keyword">_class_t</span> *L_OBJC_LABEL_CLASS_$ [<span class="number">1</span>] __attribute__((used, section (<span class="string">"__DATA, __objc_classlist,regular,no_dead_strip"</span>)))= &#123;</span><br><span class="line">	&amp;OBJC_CLASS_$_EOCObject,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>拿到当前的文件中所有的自定义类，暂时还没有看到变量<code>L_OBJC_LABEL_CLASS_$</code>的用处。</p>
<div class="note info"><p><strong>本文作者：</strong>意林<br><strong>本文链接：</strong><a href="http://www.shinancao.cn/2019/06/03/iOS-clang-1" target="_blank" rel="external">http://www.shinancao.cn/2019/06/03/iOS-clang-1</a><br><strong>版权声明：</strong>本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/3.0/" target="_blank" rel="external">CC BY-NC-SA 3.0</a> 许可协议。转载请注明出处！</p>
</div>
      
    </div>

    <div>
      
        

      
    </div>

    <div>
      
        

      
    </div>

    <div>
      
        

      
    </div>

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/Objective-C/" rel="tag"># Objective-C</a>
          
            <a href="/tags/clang/" rel="tag"># clang</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2019/06/01/iOS-Runtime-1/" rel="next" title="通过Runtime源码看Objective-C的动态性  ">
                <i class="fa fa-chevron-left"></i> 通过Runtime源码看Objective-C的动态性  
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2019/06/08/iOS-block-1/" rel="prev" title="轻松理解Block  ">
                轻松理解Block   <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          
  <div class="comments" id="comments">
    
      <div id="gitment_container"></div>
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap" >
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/images/avatar.jpg"
               alt="意林" />
          <p class="site-author-name" itemprop="name">意林</p>
           
              <p class="site-description motion-element" itemprop="description"></p>
           
        </div>
        <nav class="site-state motion-element">

          
            <div class="site-state-item site-state-posts">
              <a href="/archives/">
                <span class="site-state-item-count">54</span>
                <span class="site-state-item-name">日志</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-categories">
              <a href="/categories/index.html">
                <span class="site-state-item-count">11</span>
                <span class="site-state-item-name">分类</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-tags">
              <a href="/tags/index.html">
                <span class="site-state-item-count">83</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/shinancao" target="_blank" rel="external nofollow" title="GitHub">
                  
                  GitHub
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://weibo.com/3178558825/profile?topnav=1&wvr=6&is_all=1" target="_blank" rel="external nofollow" title="微博">
                  
                  微博
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="https://www.douban.com/people/150971507/" target="_blank" rel="external nofollow" title="豆瓣">
                  
                  豆瓣
                </a>
              </span>
            
          
        </div>

        
        

        
        

        


      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#准备OC代码，并编译"><span class="nav-number">1.</span> <span class="nav-text">准备OC代码，并编译</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#分析生成的-cpp文件"><span class="nav-number">2.</span> <span class="nav-text">分析生成的.cpp文件</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">意林</span>
</div>


<div class="powered-by">
  由 <a class="theme-link" href="https://hexo.io" rel="external nofollow">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next" rel="external nofollow">
    NexT.Mist
  </a>
</div>


        

        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.1"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.1"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.1"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.1"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.1"></script>



  


  




	





  





  






	
		
		
		
		<link rel="stylesheet" href="https://imsun.github.io/gitment/style/default.css">
		<script src="https://imsun.github.io/gitment/dist/gitment.browser.js"></script>
		<script>
			var gitment = new Gitment({
			  //id: '页面 ID',
			  owner: 'shinancao',
			  repo: 'shinancao.github.io',
			  oauth: {
				client_id: 'd9ac25dfb2084f02efb1',
				client_secret: '7b127bf1c8bccb72ea55c1220c0db3d3e505672e'
			  }
			});
			gitment.render('gitment_container');
		</script>
	


  





  

  
<script>
(function(){
    var bp = document.createElement('script');
    var curProtocol = window.location.protocol.split(':')[0];
    if (curProtocol === 'https') {
        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';        
    }
    else {
        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
    }
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
})();
</script>


  

  

  

  

</body>
</html>
